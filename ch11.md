如第5节所讨论的，许多计算机系统被组织成用户软件和系统软件两层。系统软件（例如，操作系统内核和设备驱动程序）是负责保护和管理整个系统的软件，包括**与外设交互**以**执行输入和输出操作**以及**加载、调度、执行用户应用程序**。用户软件通常仅限于对（普通）寄存器和主存上的数据执行操作。每当用户软件需要执行需要与系统其他部分交互的操作时，例如从文件中读取数据或在计算机显示器上显示信息，它就调用系统软件来替它执行该过程。

本章讨论保护系统免受错误或恶意用户程序侵害的硬件机制，以及如何编程实现这些机制。

# 11.1 特权等级

ISA定义了软件可以用来执行计算的资源集。例如它定义了指令、指令的行为和操作数，以及寄存器。

**特权级别**（privilege level ）定义了软件可以访问ISA中定义哪些的资源（寄存器、指令等）。它们可以用来限制软件的执行，并保护系统免受试图执行不允许的操作的软件的攻击。例如，可以将系统配置为以受限制的特权级别执行用户应用程序，以防止它们直接与外设交互或访问特殊的寄存器。RISC-V的ISA定义了三种特权级别：

* U：User/Application  
* S：Supervisor  
* M：Machine

Machine特权级别具有最高的特权，允许对硬件进行完全访问。Supervisor权限级别具有第二高的权限，User/Application权限级别具有最低的权限。

实现RISC-V硬件时，可以实现这些特权级别的部分或全部。例如，当为紧凑和直接的嵌入式系统实现硬件时，可能只需要Machine特权级别。而为依赖于操作系统来管理应用程序（例如，桌面计算机系统）的系统实现硬件时，通常包括所有三个特权级别，以便于操作系统的实现。

RISC-V**特权模式**（privilege mode）定义了当前正在执行的软件的特权级别。例如，当Machine特权模式处于活跃状态时，当前执行的软件具有Machine特权级别，因此具有对硬件的完全访问权限。

**非特权模式**（unprivileged mode ）是特权最低的模式。在RISCV中，无特权模式是User/Application特权模式，也称为**用户模式**或**U模式**。**非特权ISA**是在非特权模式下运行的软件可以访问的ISA子集。

为了简化讨论，本章剩下的部分将集中讨论只有U模式和Machine模式的RISC-V处理器。



# 11.2  保护系统

# 11.3 异常（Exception）

# 11.4 软中断（Software Interrupts  ）

# 11.5 保护RISC-V系统

## 11.5.1 改变特权等级

## 11.5.2 配置执行与软中断机制

## 11.5.3 处理非法操作

## 11.5.4 处理系统调用