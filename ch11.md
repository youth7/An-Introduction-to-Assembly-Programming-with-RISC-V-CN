如第5节所讨论的，许多计算机系统被组织成用户软件和系统软件两层。系统软件（例如，操作系统内核和设备驱动程序）是负责保护和管理整个系统的软件，包括**与外设交互**以**执行输入和输出操作**以及**加载、调度、执行用户应用程序**。用户软件通常仅限于对（普通）寄存器和主存上的数据执行操作。每当用户软件需要执行需要与系统其他部分交互的操作时，例如从文件中读取数据或在计算机显示器上显示信息，它就调用系统软件来替它执行该过程。

本章讨论保护系统免受错误或恶意用户程序侵害的硬件机制，以及如何编程实现这些机制。

# 11.1 特权等级

ISA定义了软件可以用来执行计算的资源集。例如它定义了指令、指令的行为和操作数，以及寄存器。

**特权级别**（privilege level ）定义了软件可以访问ISA中定义哪些的资源（寄存器、指令等）。它们可以用来限制软件的执行，并保护系统免受试图执行不允许的操作的软件的攻击。例如，可以将系统配置为以受限制的特权级别执行用户应用程序，以防止它们直接与外设交互或访问特殊的寄存器。RISC-V的ISA定义了三种特权级别：

* U：User/Application  
* S：Supervisor  
* M：Machine

Machine特权级别具有最高的特权，允许对硬件进行完全访问。Supervisor权限级别具有第二高的权限，User/Application权限级别具有最低的权限。

实现RISC-V硬件时，可以实现这些特权级别的部分或全部。例如，当为紧凑和直接的嵌入式系统实现硬件时，可能只需要Machine特权级别。而为依赖于操作系统来管理应用程序（例如，桌面计算机系统）的系统实现硬件时，通常包括所有三个特权级别，以便于操作系统的实现。

RISC-V**特权模式**（privilege mode）定义了当前正在执行的软件的特权级别。例如，当Machine特权模式处于活跃状态时，当前执行的软件具有Machine特权级别，因此具有对硬件的完全访问权限。

**非特权模式**（unprivileged mode ）是特权最低的模式。在RISCV中，无特权模式是User/Application特权模式，也称为**用户模式**或**U模式**。**非特权ISA**是在非特权模式下运行的软件可以访问的ISA子集。

为了简化讨论，本章剩下的部分将集中讨论只有U模式和Machine模式的RISC-V处理器。



# 11.2  保护系统

U模式限制了当前执行的软件可以访问的资源；因此，为了保护系统不受错误或恶意用户程序的影响，系统软件通常在执行（或返回控制）用户代码之前，将特权模式设置为U模式。

通常采取以下措施来保护系统：

* **初始化系统：**上电后，硬件自动将特权模式设置为Machine模式，并开始执行boot code（它的功能是引导系统的启动，即对硬件系统进行初始化，并加载OS的代码）。boot code将OS加载到内存中，并在Machine模式下调用OS中的始化代码来配置整个系统。
* **执行用户代码：**一旦设置完毕，OS就可以将用户程序加载到主存中执行。但是，在转移控制以执行用户代码之前，它将特权模式设置为U模式。
* **处理非法操作：**如果用户软件试图执行特权操作，例如与外设交互，硬件将停止执行用户代码并调用OS的来处理非法操作。将在11.3节讨论硬件如何通过异常处理机制将控制权转移到OS。
* **调用OS（的功能）：**如果用户程序需要执行一个敏感的过程，例如向外设输出信息，它必须请求OS来为它执行此操作。当将控制权转移到OS时，硬件必须将特权模式改为Supervisor模式或Machine模式，这样OS才能以适当的特权执行操作。为此，ISA通常包含一种称为软件中断（software interrupt）的机制，允许在非特权模式下切换到特权模式，并调用OS的代码。这种机制使得用户代码不能改变特权模式并执行自己的代码。一旦操作系统为用户程序完成相关操作，它将特权模式更改回U模式，并返回到用户程序。
* **调用操作系统（的功能）：**如果用户程序需要执行一个敏感的操作，例如向外设输出，它必须调用操作系统来为它实行该操作。
* **处理外部中断：**当外部中断发生时，硬件将特权模式设置为Machine模式，因此ISR有足够的特权来处理中断。请注意，ISR属于系统程序。

# 11.3 异常（Exception）

# 11.4 软中断（Software Interrupts  ）

# 11.5 保护RISC-V系统

## 11.5.1 改变特权等级

## 11.5.2 配置执行与软中断机制

## 11.5.3 处理非法操作

## 11.5.4 处理系统调用